

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Engine &mdash; tk-alias v4.1.6 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/graphviz.css" type="text/css" />
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Hooks" href="hooks.html" />
    <link rel="prev" title="What’s New" href="changes.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
    <a href='https://help.autodesk.com/view/SGDEV/ENU/'>
    
        <img style='width: 191px;
                height: 60px;
                margin: 2px;
                border-radius: 0px;
                padding: 0px;'
            src='_static/logo@2x.png'/>
    
    </a>
    

          
          
          <a href="index.html" class="icon icon-home">
            tk-alias
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
    
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="changes.html">What’s New</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="hooks.html">Hooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="environment_vars.html">Environment Variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Troubleshooting</a></li>
</ul>


    <a href='genindex.html'>Alphabetic Index</a>

    <div style='margin-top: 50px;
                margin-left: 10px;
                margin-right: 10px;
                padding: 10px;
                color: #b3b3b3;
                font-size: 70%;
                border-radius: 3px;
                background-color: #444;
                line-height: 18px;
                '>
    <style>
        a.custom_post_menu { display: inline;
                             padding: 0px;
                             text-decoration: underline; }
    </style>

    <b>tk-alias</b> v4.1.6.<br>
    
        This documentation is part of the Flow Production Tracking.
    
    For more information, please visit
    <a class=custom_post_menu href='https://help.autodesk.com/view/SGDEV/ENU/'>The Flow Production Tracking developer portal.</a>.
    The code associated with this documentation can be found
    <a class=custom_post_menu href='https://github.com/shotgunsoftware/tk-alias'>here</a>.

    </div>
    <style>
        p.privacy_links { margin: 4px 0px;}
    </style>
    <p class="privacy_links"><a data-opt-in-preferences href="javascript:;">Privacy settings</a></p>
    <p class="privacy_links"><a data-wat-linkname="manage-ccpa-settings-footer-link" href="javascript:;">Do not sell my personal information</a></p>
    <p class="privacy_links"><a href="https://www.autodesk.com/company/legal-notices-trademarks/privacy-statement">Privacy/Cookies</a></p>



        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">tk-alias</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Engine</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="engine">
<span id="id1"></span><h1>Engine<a class="headerlink" href="#engine" title="Permalink to this heading"></a></h1>
<p>The <code class="xref py py-class docutils literal notranslate"><span class="pre">AliasEngine</span></code> is the main class which constructs and initializes the Toolkit engine.</p>
<div class="highlight-python notranslate" id="engine-members"><div class="highlight"><pre><span></span><span class="c1"># Copyright (c) 2023 Autodesk Inc.</span>
<span class="c1">#</span>
<span class="c1"># CONFIDENTIAL AND PROPRIETARY</span>
<span class="c1">#</span>
<span class="c1"># This work is provided &quot;AS IS&quot; and subject to the ShotGrid Pipeline Toolkit</span>
<span class="c1"># Source Code License included in this distribution package. See LICENSE.</span>
<span class="c1"># By accessing, using, copying or modifying this work you indicate your</span>
<span class="c1"># agreement to the ShotGrid Pipeline Toolkit Source Code License. All rights</span>
<span class="c1"># not expressly granted therein are reserved by Autodesk Inc.</span>


<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pprint</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">sgtk</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sgtk.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">LocalFileStorageManager</span>


<span class="k">class</span><span class="w"> </span><span class="nc">AliasEngine</span><span class="p">(</span><span class="n">sgtk</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">Engine</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Alias engine for Flow Production Tracking Toolkit.&quot;&quot;&quot;</span>

    <span class="c1"># The name of the hidden window, used to parent SG widgets to the Alias main window.</span>
    <span class="n">__PROXY_WINDOW_TITLE</span> <span class="o">=</span> <span class="s2">&quot;sgtk dialog owner proxy&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tk</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">engine_instance_name</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the engine.&quot;&quot;&quot;</span>

        <span class="c1"># Get all environment variables that the engine cares about</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias_execpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;TK_ALIAS_EXECPATH&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias_bindir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alias_execpath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias_codename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;TK_ALIAS_CODENAME&quot;</span><span class="p">,</span> <span class="s2">&quot;autostudio&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias_version</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;TK_ALIAS_VERSION&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__hostname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SHOTGRID_ALIAS_HOST&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__namespace</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SHOTGRID_ALIAS_NAMESPACE&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__port</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SHOTGRID_ALIAS_PORT&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__port</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__port</span><span class="p">)</span>

        <span class="c1"># The tk-alias python module</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tk_alias</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Keep track of the Flow Production Tracking context by stage name and path to allow context switching.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_contexts_by_stage_name</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_contexts_by_path</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># The menu generator is responsible for adding the Flow Production Tracking menu to the Alias window.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__menu_generator</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># The event watcher manages handling Alias event callbacks.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__event_watcher</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># The data validator provides the functionality for validating Alias data. This is</span>
        <span class="c1"># set up to be used by the Data Validation App.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__data_validator</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># A socketio client used to communicate with Alias in OpenModel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__sio</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Information about the server that the socketio client is connected to.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__server_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Information about the plugin that bootstrapped the engine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__plugin_info</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># This module will be initialized with the Alias Python API and utility functions on</span>
        <span class="c1"># calling &#39;__init_api&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__alias_py</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Create a QWidget to parent all Flow Production Tracking windows to. This widget will set its parent</span>
        <span class="c1"># as the Alias main window.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__proxy_window</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># When running in the same process as Alias (for Alias versions &lt;2024.0), the engine</span>
        <span class="c1"># will create the qt app instance.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__qt_app</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s2">&quot;argv&quot;</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>

        <span class="c1"># Flag inidicating if Flow Production Tracking is running in the same process as Alias. This will</span>
        <span class="c1"># determine how Flow Production Tracking will communicate with Alias.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__in_alias_process</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;Alias.exe&quot;</span>
        <span class="n">open_model</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;TK_ALIAS_OPEN_MODEL&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">open_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># For backward compatibility, OpenModel mode is when not executing in the same process</span>
            <span class="c1"># as Alias</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__is_open_model</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__in_alias_process</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__is_open_model</span> <span class="o">=</span> <span class="n">open_model</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">)</span>

        <span class="c1"># Determine if the engine is running with a GUI or not</span>
        <span class="k">if</span> <span class="s2">&quot;TK_ALIAS_HAS_UI&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="c1"># Found the environment variable to explicitly turn on/off GUI mode.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__has_ui</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TK_ALIAS_HAS_UI&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="s2">&quot;1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;true&quot;</span><span class="p">,</span>
                <span class="s2">&quot;True&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Not explicitly defined to have a UI, we will say there is a UI if running in the</span>
            <span class="c1"># same process as Alias (for backward compatibility)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__has_ui</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__in_alias_process</span>

        <span class="c1"># Call the base engine init method</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">tk</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">engine_instance_name</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>

    <span class="c1"># -------------------------------------------------------------------------------------------------------</span>
    <span class="c1"># Plugin version &lt; 4.0.0 methods</span>
    <span class="c1"># -------------------------------------------------------------------------------------------------------</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_current_engine</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the engine that Toolkit is currently running. This is used by the Alias</span>
<span class="sd">        C++ Plugin to ensure that its reference to the engine is not stale (e.g. the</span>
<span class="sd">        plugin&#39;s reference will become stale after the engine has been reloaded).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">sgtk</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">current_engine</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_plugin_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plugin</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">python</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called on plugin initialization for shotgrid.plugin (plugin version &lt;= 3) and for</span>
<span class="sd">        Alias version &lt; 2024.0.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Plugin initialized: v</span><span class="si">{</span><span class="n">plugin</span><span class="si">}</span><span class="s2"> Alias v</span><span class="si">{</span><span class="n">alias</span><span class="si">}</span><span class="s2"> Python v</span><span class="si">{</span><span class="n">python</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__plugin_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;plugin_version&quot;</span><span class="p">:</span> <span class="n">plugin</span><span class="p">,</span>
            <span class="s2">&quot;alias_version&quot;</span><span class="p">:</span> <span class="n">alias</span><span class="p">,</span>
            <span class="s2">&quot;python_version&quot;</span><span class="p">:</span> <span class="n">python</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="c1"># -------------------------------------------------------------------------------------------------------</span>
    <span class="c1"># Properties</span>
    <span class="c1"># -------------------------------------------------------------------------------------------------------</span>

    <span class="c1"># -------------------------------------------------------------------------------------------------------</span>
    <span class="c1"># Base Engine properties</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">host_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns information about the application hosting this engine.</span>

<span class="sd">        :returns: A {&quot;name&quot;: application name, &quot;version&quot;: application version}</span>
<span class="sd">                  dictionary. eg: {&quot;name&quot;: &quot;AfterFX&quot;, &quot;version&quot;: &quot;2017.1.1&quot;}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Alias&quot;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plugin_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;alias_version&quot;</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">has_ui</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if Alias is running in interactive mode (OpenAlias), otherwise False (for OpenModel).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__has_ui</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">context_change_allowed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Specifies that context changes are allowed by the engine.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1"># -------------------------------------------------------------------------------------------------------</span>
    <span class="c1"># Alias Engine properties</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">plugin_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the information about the plugin the engine is running with.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__plugin_info</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">in_alias_process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get whether or not the engine is running in the same process as Alias or not.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__in_alias_process</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">alias_py</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the AliasPy object that can be used to communicate with Alias.</span>

<span class="sd">        Use the AliasPy.api property to access the Alias API and make requests. Use the other</span>
<span class="sd">        AliasPy properties for api helper methods.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__alias_py</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">event_watcher</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the AliasEventWatcher object to help manager Alias message events and Python callbacks.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__event_watcher</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">data_validator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the AliasDataValidator object to help validate the Alias data.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data_validator</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">executable_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the path to the currently running Alias executable.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_execpath</span>

    <span class="c1"># -------------------------------------------------------------------------------------------------------</span>
    <span class="c1"># Override base Engine class methods</span>
    <span class="c1"># -------------------------------------------------------------------------------------------------------</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">pre_app_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets up the engine into an operational state. Executed by the system and typically</span>
<span class="sd">        implemented by deriving classes. This method called before any apps are loaded.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: Initializing...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,))</span>

        <span class="c1"># Ensure that the framework has been initialiazed. This must be called</span>
        <span class="c1"># before import &#39;tk-alias&#39; module, since this module will attempt to</span>
        <span class="c1"># import the framework.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__ensure_framework</span><span class="p">()</span>

        <span class="c1"># Import python/tk_alias module</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tk_alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s2">&quot;tk_alias&quot;</span><span class="p">)</span>

        <span class="c1"># Initialize the Alias Python API module (requires tk_alias module)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__init_api</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__hostname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__port</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__namespace</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sio</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__server_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sio</span><span class="o">.</span><span class="n">call_threadsafe</span><span class="p">(</span><span class="s2">&quot;server_info&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__plugin_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__server_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;client&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Alias server info: </span><span class="si">{</span><span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__server_info</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># No server, we&#39;re in OpenModel mode.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__server_info</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">post_app_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This method called after all apps have been loaded.&quot;&quot;&quot;</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">sgtk.platform.qt</span><span class="w"> </span><span class="kn">import</span> <span class="n">QtGui</span>

        <span class="c1"># If qt is already running (e.g. on engine restart) do the post qt init now, otherwise</span>
        <span class="c1"># post_qt_init will be called in startup/bootstrap.py after engine created.</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">instance</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">post_qt_init</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">post_context_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_context</span><span class="p">,</span> <span class="n">new_context</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs after a context change has occurred.</span>

<span class="sd">        :param old_context: The previous context.</span>
<span class="sd">        :param new_context: The current context.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: Post context change...&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Rebuild the menu only if we change of context and if we&#39;re running Alias in interactive mode</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_ui</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__menu_generator</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__menu_generator</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">destroy_engine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Called when the engine should tear down itself and all its apps.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: Destroying...&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__event_watcher</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__event_watcher</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__event_watcher</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__menu_generator</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sio</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sio</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;No connection to Alias server. Can&#39;t remove ShotGrid menu.&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__menu_generator</span><span class="o">.</span><span class="n">remove_menu</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__menu_generator</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Close all Shotgun app dialogs that are still opened since some apps do threads</span>
        <span class="c1"># cleanup in their onClose event handler</span>
        <span class="c1"># Note that this function is called when the engine is restarted (through &quot;Reload</span>
        <span class="c1"># Engine and Apps&quot;)</span>
        <span class="c1">#</span>
        <span class="c1"># Important: Copy the list of dialogs still opened since the call to close() will modify created_qt_dialogs</span>
        <span class="n">dialogs_still_opened</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">created_qt_dialogs</span><span class="p">[:]</span>
        <span class="k">for</span> <span class="n">dialog</span> <span class="ow">in</span> <span class="n">dialogs_still_opened</span><span class="p">:</span>
            <span class="n">dialog</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sio</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sio</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__sio</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__sio</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__qt_app</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__qt_app</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">show_panel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">panel_id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">widget_class</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show a dialog as panel in Alias as they are not properly supported. In case the widget has already been opened,</span>
<span class="sd">        do not create a second widget but use the existing one instead.</span>

<span class="sd">        :param panel_id: Unique identifier for the panel, as obtained by register_panel().</span>
<span class="sd">        :param title: The title of the panel</span>
<span class="sd">        :param bundle: The app, engine or framework object that is associated with this window</span>
<span class="sd">        :param widget_class: The class of the UI to be constructed. This must derive from QWidget.</span>

<span class="sd">        Additional parameters specified will be passed through to the widget_class constructor.</span>

<span class="sd">        :returns: the created widget_class instance</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Begin showing panel </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">panel_id</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_ui</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Sorry, this environment does not support UI display! Cannot show &quot;</span>
                <span class="s2">&quot;the requested window &#39;</span><span class="si">{}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># try to find existing window in order to avoid having many instances of the same app opened at the same time</span>
        <span class="k">for</span> <span class="n">qt_dialog</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">created_qt_dialogs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">qt_dialog</span><span class="p">,</span> <span class="s2">&quot;_widget&quot;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">qt_dialog</span><span class="o">.</span><span class="n">_widget</span><span class="o">.</span><span class="n">objectName</span><span class="p">()</span> <span class="o">==</span> <span class="n">panel_id</span><span class="p">:</span>
                <span class="n">widget_instance</span> <span class="o">=</span> <span class="n">qt_dialog</span>
                <span class="n">widget_instance</span><span class="o">.</span><span class="n">raise_</span><span class="p">()</span>
                <span class="n">widget_instance</span><span class="o">.</span><span class="n">activateWindow</span><span class="p">()</span>
                <span class="k">break</span>
        <span class="c1"># in case we can&#39;t find an existing widget, create a new one</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Widgets application</span>
            <span class="n">widget_instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_dialog</span><span class="p">(</span>
                <span class="n">title</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">widget_class</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
            <span class="n">widget_instance</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="n">panel_id</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">widget_instance</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_dialog_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get Alias dialog parent window.&quot;&quot;&quot;</span>

        <span class="c1"># No parent dialog if the engine is not running in GUI mode.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_ui</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">window</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_or_create_proxy_window</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">window</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">window</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_get_dialog_parent</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_emit_log_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by the engine to log messages in Alias Terminal.</span>
<span class="sd">        All log messages from the toolkit logging namespace will be passed to this method.</span>

<span class="sd">        :param handler: Log handler that this message was dispatched from.</span>
<span class="sd">                        Its default format is &quot;[levelname basename] message&quot;.</span>
<span class="sd">        :type handler: :class:`~python.logging.LogHandler`</span>
<span class="sd">        :param record: Standard python logging record.</span>
<span class="sd">        :type record: :class:`~python.logging.LogRecord`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: improve Alias API to redirect the logs to the Alias Promptline</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_dark_look_and_feel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Override the base engine method.</span>

<span class="sd">        Apply specific styling for Alias.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">sgtk.platform.qt</span><span class="w"> </span><span class="kn">import</span> <span class="n">QtGui</span>

        <span class="c1"># Initialize the SG Toolkit style to the application.</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_initialize_dark_look_and_feel</span><span class="p">()</span>

        <span class="c1"># Apply Alias specific styling</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
        <span class="n">app_palette</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">palette</span><span class="p">()</span>
        <span class="c1"># The default placeholder text for Alias is black, let&#39;s set it back to</span>
        <span class="c1"># the text color (as it was in Qt5), but with the current placeholder</span>
        <span class="c1"># text alpha value.</span>
        <span class="n">new_placeholder_text_color</span> <span class="o">=</span> <span class="n">app_palette</span><span class="o">.</span><span class="n">text</span><span class="p">()</span><span class="o">.</span><span class="n">color</span><span class="p">()</span>
        <span class="n">placeholder_text_color</span> <span class="o">=</span> <span class="n">app_palette</span><span class="o">.</span><span class="n">placeholderText</span><span class="p">()</span><span class="o">.</span><span class="n">color</span><span class="p">()</span>
        <span class="n">new_placeholder_text_color</span><span class="o">.</span><span class="n">setAlpha</span><span class="p">(</span><span class="n">placeholder_text_color</span><span class="o">.</span><span class="n">alpha</span><span class="p">())</span>
        <span class="n">app_palette</span><span class="o">.</span><span class="n">setColor</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QPalette</span><span class="o">.</span><span class="n">PlaceholderText</span><span class="p">,</span> <span class="n">new_placeholder_text_color</span><span class="p">)</span>
        <span class="c1"># Set the palette back with the Alias specific styling</span>
        <span class="n">app</span><span class="o">.</span><span class="n">setPalette</span><span class="p">(</span><span class="n">app_palette</span><span class="p">)</span>

    <span class="c1"># -------------------------------------------------------------------------------------------------------</span>
    <span class="c1"># Public methods</span>
    <span class="c1"># -------------------------------------------------------------------------------------------------------</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">restart_process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Restart the process that the engine is running in.</span>

<span class="sd">        This is only applicable when the engine has a socketio client set up to communicate</span>
<span class="sd">        with Alias (e.g. OpenAlias mode).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Restarting the Alias Engine...&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sio</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__menu_generator</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__menu_generator</span><span class="o">.</span><span class="n">remove_menu</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_py</span><span class="o">.</span><span class="n">AlStatusCode</span><span class="o">.</span><span class="n">Success</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Removed Flow Production Tracking menu from Alias successfully.&quot;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_py</span><span class="o">.</span><span class="n">AlStatusCode</span><span class="o">.</span><span class="n">Failure</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Failed to remove Flow Production Tracking menu from Alias&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Alias Python API menu.remove() returned non-success status code </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__menu_generator</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__sio</span><span class="o">.</span><span class="n">emit_threadsafe</span><span class="p">(</span><span class="s2">&quot;restart&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shutdown the application running the engine.</span>

<span class="sd">        This method attempts to exit the Qt application runnign the engine, which will be</span>
<span class="sd">        responsible for ensuring that the engine is destroyed properly (e.g. calling destroy</span>
<span class="sd">        on the engine itself).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Shutting down the Alias Engine...&quot;</span><span class="p">)</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">sgtk.platform.qt</span><span class="w"> </span><span class="kn">import</span> <span class="n">QtGui</span>

        <span class="n">qt_app</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">__qt_app</span>
        <span class="k">if</span> <span class="n">qt_app</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute_in_main_thread</span><span class="p">(</span><span class="n">qt_app</span><span class="o">.</span><span class="n">quit</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Destroy the engine if there is no qt app</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute_in_main_thread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">destroy</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__init_qt_app</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the Qt Application.</span>

<span class="sd">        This should only be called when Flow Production Tracking is running in the same process as Alias, and</span>
<span class="sd">        Alias does not create a Qt Application (for Alias &lt; 2024.0).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">sgtk.platform.qt</span><span class="w"> </span><span class="kn">import</span> <span class="n">QtCore</span><span class="p">,</span> <span class="n">QtGui</span>

        <span class="n">pyside_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span>
        <span class="n">site_packages_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">pyside_folder</span><span class="p">)</span>
        <span class="n">lib_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">site_packages_folder</span><span class="p">)</span>
        <span class="n">python_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">lib_folder</span><span class="p">)</span>
        <span class="n">shotgun_create_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">python_folder</span><span class="p">)</span>
        <span class="n">qt_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">shotgun_create_folder</span><span class="p">,</span> <span class="s2">&quot;Qt&quot;</span><span class="p">)</span>

        <span class="c1"># PySide plugins</span>
        <span class="n">plugins_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pyside_folder</span><span class="p">,</span> <span class="s2">&quot;plugins&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">plugins_dir</span><span class="p">):</span>
            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">addLibraryPath</span><span class="p">(</span><span class="n">plugins_dir</span><span class="p">)</span>

        <span class="c1"># QT plugins</span>
        <span class="n">plugins_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">qt_folder</span><span class="p">,</span> <span class="s2">&quot;plugins&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">plugins_dir</span><span class="p">):</span>
            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">addLibraryPath</span><span class="p">(</span><span class="n">plugins_dir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__qt_app</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__qt_app</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__qt_app</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;Flow Production Tracking Alias Engine&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__qt_app</span><span class="o">.</span><span class="n">setQuitOnLastWindowClosed</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">_app_quit</span><span class="p">():</span>
                <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">__qt_app</span><span class="o">.</span><span class="n">aboutToQuit</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">_app_quit</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">post_qt_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the engine after Qt has been initialized and an app has been created.</span>

<span class="sd">        This is used by the startup/bootstrap.py to finish setting up the engine after the</span>
<span class="sd">        Qt app instance has been created, but before the event loop has started.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">sgtk.platform.qt</span><span class="w"> </span><span class="kn">import</span> <span class="n">QtCore</span><span class="p">,</span> <span class="n">QtGui</span>

        <span class="n">instance</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">instance</span><span class="p">:</span>
            <span class="c1"># Nothing to do if there is no QApplication running.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Attempted to initialize for Qt but Qt application instance not found.&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__has_ui</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span>

        <span class="c1"># Ensure that the has ui flag has been set, though it should have been set on engine</span>
        <span class="c1"># creation to ensure it was initialized properly.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__has_ui</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Initialie the SG Toolkit style to the application.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_dark_look_and_feel</span><span class="p">()</span>

        <span class="c1"># unicode characters returned by the shotgun api need to be converted</span>
        <span class="c1"># to display correctly in all of the app windows</span>
        <span class="c1"># tell QT to interpret C strings as utf-8</span>
        <span class="n">utf8</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QTextCodec</span><span class="o">.</span><span class="n">codecForName</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">QtCore</span><span class="o">.</span><span class="n">QTextCodec</span><span class="o">.</span><span class="n">setCodecForCStrings</span><span class="p">(</span><span class="n">utf8</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;set utf-8 codec for widget text&quot;</span><span class="p">)</span>

        <span class="c1"># Create the parent dialog for Flow Production Tracking widgets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__get_or_create_proxy_window</span><span class="p">()</span>

        <span class="c1"># Check that the Alias version is supported. Pop up a warning dialog if not.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__check_version_support</span><span class="p">()</span>

        <span class="c1"># Initialize engine members that require Qt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__menu_generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tk_alias</span><span class="o">.</span><span class="n">menu_generation</span><span class="o">.</span><span class="n">AliasMenuGenerator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__data_validator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tk_alias</span><span class="o">.</span><span class="n">data_validator</span><span class="o">.</span><span class="n">AliasDataValidator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__event_watcher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__init_alias_event_watcher</span><span class="p">()</span>

        <span class="c1"># Build the Flow Production Tracking menu in Alias. It will be added to the Alias main menu bar.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__menu_generator</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>

        <span class="c1"># Run the start up commands</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__run_app_instance_commands</span><span class="p">()</span>

        <span class="c1"># Check if there is a file set to open on startup</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SGTK_FILE_TO_OPEN&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sio</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Add a timer to delay opening the file for 5 seconds. This is a work around for</span>
                <span class="c1"># Alias when running SG in the same process (&lt;2024), which is not ready to open</span>
                <span class="c1"># a file on engine startup. This is not a bullet proof solution, but it should</span>
                <span class="c1"># work in most cases, and there is not a better alternative to support older</span>
                <span class="c1"># versions of Alias.</span>
                <span class="n">QtCore</span><span class="o">.</span><span class="n">QTimer</span><span class="o">.</span><span class="n">singleShot</span><span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
            <span class="c1"># Clear the env var after loading so that it doesn&#39;t get reopened on an engine restart.</span>
            <span class="k">del</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;SGTK_FILE_TO_OPEN&quot;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_context_for_stage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the context associated to the current Alias stage.</span>
<span class="sd">        We need to save and restore the context because of the different stages the user can use.</span>
<span class="sd">        As the Stages can change their name, we need to store the context for both the stage name and the stage path.</span>

<span class="sd">        :param context:  We can specify a context to associate to the current stage. If no one is supplied, we will use</span>
<span class="sd">                         the current one.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span>

        <span class="n">current_stage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_py</span><span class="o">.</span><span class="n">get_current_stage</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">current_stage</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">current_stage</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_contexts_by_path</span><span class="p">[</span><span class="n">current_stage</span><span class="o">.</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_contexts_by_stage_name</span><span class="p">[</span><span class="n">current_stage</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">context</span>

    <span class="c1">#####################################################################################</span>
    <span class="c1"># File I/O</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience function to call the Alias Python API to save the file and ensure</span>
<span class="sd">        the context is saved for the current stage.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_py</span><span class="o">.</span><span class="n">save_file</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_py</span><span class="o">.</span><span class="n">AlStatusCode</span><span class="o">.</span><span class="n">Failure</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Alias Python API save_file failed&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">status</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_py</span><span class="o">.</span><span class="n">AlStatusCode</span><span class="o">.</span><span class="n">Success</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Alias Python API save_file returned non-success status code </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">status</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Save context for the current stage that was updated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_context_for_stage</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_file_as</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience function to call the Alias Python API to save the file and ensure</span>
<span class="sd">        the context is saved for the current stage.</span>

<span class="sd">        :param path: the file path to save.</span>
<span class="sd">        :type path: str</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_py</span><span class="o">.</span><span class="n">save_file_as</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_py</span><span class="o">.</span><span class="n">AlStatusCode</span><span class="o">.</span><span class="n">Failure</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Alias Python API save_file_as failed&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">status</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_py</span><span class="o">.</span><span class="n">AlStatusCode</span><span class="o">.</span><span class="n">Success</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Alias Python API save_file_as(&#39;</span><span class="si">{}</span><span class="s2">&#39;) returned non-success status code </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">path</span><span class="p">,</span> <span class="n">status</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Save context for the current stage that was updated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_context_for_stage</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">open_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience function to call the Alias Python API to open a file and ensure</span>
<span class="sd">        the context is saved for the current stage.</span>

<span class="sd">        :param path: the file path to open.</span>
<span class="sd">        :type path: str</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_py</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_py</span><span class="o">.</span><span class="n">AlStatusCode</span><span class="o">.</span><span class="n">Failure</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Alias Python API open_file failed&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">status</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_py</span><span class="o">.</span><span class="n">AlStatusCode</span><span class="o">.</span><span class="n">Success</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Alias Python API open_file(&#39;</span><span class="si">{}</span><span class="s2">&#39;) returned non-success status code </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">path</span><span class="p">,</span> <span class="n">status</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Save context for the current stage that was updated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_context_for_stage</span><span class="p">()</span>

    <span class="c1">#####################################################################################</span>
    <span class="c1"># AliasEventWatcher callbacks</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_stage_active</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a callback that is triggered by Alias &quot;StageCreated&quot; events.</span>

<span class="sd">        Update the Flow Production Tracking context according to the current stage (since it may have changed).</span>

<span class="sd">        :param result: The result of the Alias stage created event.</span>
<span class="sd">        :type result: alias_api.PythonCallbackMessageResult</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">current_stage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_py</span><span class="o">.</span><span class="n">get_current_stage</span><span class="p">()</span>

        <span class="c1"># Do nothing if the current stage is invalid</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">current_stage</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">current_stage</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">current_stage</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="c1"># Do nothing if there are no SG contexts saved for Alias stages yet</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contexts_by_path</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contexts_by_stage_name</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Attempt to get the saved SG context for the current Alias stage</span>
        <span class="n">context</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">current_stage</span><span class="o">.</span><span class="n">path</span> <span class="ow">and</span> <span class="n">current_stage</span><span class="o">.</span><span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contexts_by_path</span><span class="p">:</span>
            <span class="c1"># Found the context form the stage path</span>
            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contexts_by_path</span><span class="p">[</span><span class="n">current_stage</span><span class="o">.</span><span class="n">path</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">current_stage</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="n">current_stage</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contexts_by_stage_name</span><span class="p">:</span>
            <span class="c1"># Found the context form the stage name</span>
            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contexts_by_stage_name</span><span class="p">[</span><span class="n">current_stage</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Context not found, reset to the project context</span>
            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sgtk</span><span class="o">.</span><span class="n">context_from_entity_dictionary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">project</span><span class="p">)</span>

        <span class="c1"># Only change the context if we found one and it is not the current context</span>
        <span class="k">if</span> <span class="n">context</span> <span class="ow">and</span> <span class="n">context</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">change_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

    <span class="c1">#####################################################################################</span>
    <span class="c1"># QT Utils</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">open_save_as_dialog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Try to open tk-multi-workfiles2 Save As... dialog if it exists otherwise</span>
<span class="sd">        launch a Qt file browser for the Save As...</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">workfiles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tk-multi-workfiles2&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">workfiles</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">workfiles</span><span class="p">,</span> <span class="s2">&quot;show_file_save_dlg&quot;</span><span class="p">):</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;use_modal_dialog&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
                <span class="n">workfiles</span><span class="o">.</span><span class="n">show_file_save_dlg</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Alias doesn&#39;t appear to have a &quot;save as&quot; dialog accessible via</span>
            <span class="c1"># python. so open our own Qt file dialog.</span>

            <span class="kn">from</span><span class="w"> </span><span class="nn">sgtk.platform.qt</span><span class="w"> </span><span class="kn">import</span> <span class="n">QtGui</span>

            <span class="n">file_dialog</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QFileDialog</span><span class="p">(</span>
                <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_dialog_parent</span><span class="p">(),</span>
                <span class="n">caption</span><span class="o">=</span><span class="s2">&quot;Save As&quot;</span><span class="p">,</span>
                <span class="n">directory</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">),</span>
                <span class="nb">filter</span><span class="o">=</span><span class="s2">&quot;Alias file (*.wire)&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">file_dialog</span><span class="o">.</span><span class="n">setLabelText</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QFileDialog</span><span class="o">.</span><span class="n">Accept</span><span class="p">,</span> <span class="s2">&quot;Save&quot;</span><span class="p">)</span>
            <span class="n">file_dialog</span><span class="o">.</span><span class="n">setLabelText</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QFileDialog</span><span class="o">.</span><span class="n">Reject</span><span class="p">,</span> <span class="s2">&quot;Cancel&quot;</span><span class="p">)</span>
            <span class="n">file_dialog</span><span class="o">.</span><span class="n">setOption</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QFileDialog</span><span class="o">.</span><span class="n">DontResolveSymlinks</span><span class="p">)</span>
            <span class="n">file_dialog</span><span class="o">.</span><span class="n">setOption</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QFileDialog</span><span class="o">.</span><span class="n">DontUseNativeDialog</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">file_dialog</span><span class="o">.</span><span class="n">exec_</span><span class="p">():</span>
                <span class="k">return</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">file_dialog</span><span class="o">.</span><span class="n">selectedFiles</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;.wire&quot;</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">.wire&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save_file_as</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">open_delete_stages_dialog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_file</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Launch a QT prompt dialog to ask the user if he wants to delete all the existing stages or keep them when</span>
<span class="sd">        opening a new file.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">sgtk.platform.qt</span><span class="w"> </span><span class="kn">import</span> <span class="n">QtGui</span>

        <span class="k">if</span> <span class="n">new_file</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;DELETE all objects, shaders, views and actions in all existing Stage before Opening a New File?&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;DELETE all objects, shaders, views and actions in all existing Stage before Opening this File?&quot;</span>
        <span class="n">message_type</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">QtGui</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span> <span class="o">|</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">No</span> <span class="o">|</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Cancel</span>
        <span class="p">)</span>
        <span class="n">answer</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">question</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_dialog_parent</span><span class="p">(),</span> <span class="s2">&quot;Open&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">message_type</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">answer</span>

    <span class="c1">#####################################################################################</span>
    <span class="c1"># Utils</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_tk_from_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the tank instance given the project ID.</span>

<span class="sd">        This is useful when you have to deal with files from library project.</span>

<span class="sd">        This method performs the same operation as get_tk_from_project_id, except that it</span>
<span class="sd">        provides a fallback code path to ensure the pipeline configuration is loaded.</span>

<span class="sd">        :param project: The project you want to get the tank instance for.</span>
<span class="sd">        :type project: dict</span>

<span class="sd">        :return: An sgtk instance.</span>
<span class="sd">        :rtype: :class`sgtk.Sgtk`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">project_id</span> <span class="o">=</span> <span class="n">project</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>

        <span class="c1"># first of all, we need to determine if the file we&#39;re trying to import lives in the current project or in</span>
        <span class="c1"># another one</span>
        <span class="n">in_current_project</span> <span class="o">=</span> <span class="n">project_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">project</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">in_current_project</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sgtk</span>

        <span class="c1"># if the file we&#39;re trying to import lives in another project, we need to access the configuration used by this</span>
        <span class="c1"># project in order to get the right configuration settings</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pc_local_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_pipeline_configuration_local_path</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pc_local_path</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Couldn&#39;t get tank instance for project </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">project_id</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="k">return</span> <span class="n">sgtk</span><span class="o">.</span><span class="n">sgtk_from_path</span><span class="p">(</span><span class="n">pc_local_path</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_tk_from_project_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the tank instance given the project ID.</span>

<span class="sd">        This is useful when you have to deal with files from library project.</span>

<span class="sd">        NOTE use get_tk_from_project for a more robust method to get the sgtk instance.</span>

<span class="sd">        :param project_id: Id of the project you want to get the tank instance for</span>
<span class="sd">        :return: An instance of :class`sgtk.Sgtk`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># first of all, we need to determine if the file we&#39;re trying to import lives in the current project or in</span>
        <span class="c1"># another one</span>
        <span class="n">in_current_project</span> <span class="o">=</span> <span class="n">project_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">project</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">in_current_project</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sgtk</span>

        <span class="c1"># if the file we&#39;re trying to import lives in another project, we need to access the configuration used by this</span>
        <span class="c1"># project in order to get the right configuration settings</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="n">pc_local_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_pipeline_configuration_local_path</span><span class="p">(</span><span class="n">project_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pc_local_path</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Couldn&#39;t get tank instance for project </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">project_id</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="k">return</span> <span class="n">sgtk</span><span class="o">.</span><span class="n">sgtk_from_path</span><span class="p">(</span><span class="n">pc_local_path</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_reference_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tk</span><span class="p">,</span> <span class="n">sg_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the reference_template according to the given context</span>

<span class="sd">        :param tk: Instance of :class`sgtk.Sgtk` for the project we want to get the reference template from</span>
<span class="sd">        :param sg_data: Dictionary of Shotgun data containing some context information. This dictionary must contain</span>
<span class="sd">                        the &#39;task&#39; field</span>
<span class="sd">        :return: The reference template object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;task&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sg_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t find &#39;task&#39; key in sg_data dictionary&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">ctx</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">context_from_entity_dictionary</span><span class="p">(</span><span class="n">sg_data</span><span class="p">[</span><span class="s2">&quot;task&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ctx</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t find context from data: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sg_data</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="n">env</span> <span class="o">=</span> <span class="n">sgtk</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">get_environment_from_context</span><span class="p">(</span><span class="n">tk</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">env</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t get environment from context&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">engine_settings</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get_engine_settings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">engine_settings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t get engine settings&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">reference_template_name</span> <span class="o">=</span> <span class="n">engine_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reference_template&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">reference_template_name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t get reference template from settings&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">return</span> <span class="n">tk</span><span class="o">.</span><span class="n">templates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">reference_template_name</span><span class="p">)</span>

    <span class="c1"># -------------------------------------------------------------------------------------------------------</span>
    <span class="c1"># Private methods</span>
    <span class="c1"># -------------------------------------------------------------------------------------------------------</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__ensure_framework</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensure that tk-framework-alias is initialized.</span>

<span class="sd">        When the engine is launched from FPT Desktop, the engine startup is</span>
<span class="sd">        executed which initializes the framework. However, when the engine is</span>
<span class="sd">        bootstrapped in a headless mode (OpenModel), the framework is not</span>
<span class="sd">        guaranteed to be initialized. The engine depends on the framework, so</span>
<span class="sd">        ensure that it is set up correctly in this case.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__in_alias_process</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__is_open_model</span><span class="p">:</span>
            <span class="c1"># The framework should have been initialized by startup.py</span>
            <span class="c1"># prepare_launch.</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Executing in headless mode (OpenModel), ensure the framework is</span>
        <span class="c1"># initialized.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initializing tk-framework-alias for headless mode&quot;</span><span class="p">)</span>

        <span class="c1"># Ensure the environment variables are set to import the Alias Python API module</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;ALIAS_PLUGIN_CLIENT_ALIAS_VERSION&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_version</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;ALIAS_PLUGIN_CLIENT_ALIAS_EXECPATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_execpath</span>

        <span class="c1"># Get the framework location and add it to the python path. This is</span>
        <span class="c1"># required since the framework uses absolute imports.</span>
        <span class="n">tk_alias_framework</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frameworks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tk-framework-alias&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tk_alias_framework</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Missing required tk-framework-alias framework.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">framework_location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frameworks</span><span class="p">[</span><span class="s2">&quot;tk-framework-alias&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">disk_location</span>
        <span class="n">framework_python_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">framework_location</span><span class="p">,</span> <span class="s2">&quot;python&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">framework_python_path</span><span class="p">)</span>

        <span class="c1"># Get the startup utils to help initialize the framework.</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">tk_framework_alias_utils.startup</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">startup_utils</span>

        <span class="c1"># Ensure the python c extension packages are installed in order to</span>
        <span class="c1"># import the framework server module.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">startup_utils</span><span class="o">.</span><span class="n">ensure_python_packages_installed</span><span class="p">(</span>
            <span class="n">python_version</span><span class="o">=</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">minor</span><span class="p">),</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Failed to install required python packages for tk-framework-alias.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Successfully initialized framework for headless mode.</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__setup_sio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">namespace</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set up the socketio communication with Alias.</span>

<span class="sd">        Create a socketio client to connect to the running Alias server.</span>

<span class="sd">        :param hostname: The api server host name to connect to.</span>
<span class="sd">        :type hostname: str</span>
<span class="sd">        :param port: The api server port name to connect to.</span>
<span class="sd">        :type port: int</span>
<span class="sd">        :param namespace: The api server namespace to connect to.</span>
<span class="sd">        :type namespace: str</span>

<span class="sd">        :return: True if the socketio client was created and is connected to the server, False</span>
<span class="sd">            otherwise.</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Set up kwargs to pass to socketio Client</span>
        <span class="n">client_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;timeout&quot;</span><span class="p">:</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">3</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SGTK_ENFORCE_PROXY_LOCALHOST&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;true&quot;</span><span class="p">,</span>
            <span class="s2">&quot;y&quot;</span><span class="p">,</span>
            <span class="s2">&quot;yes&quot;</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="c1"># Set up a session object to disable proxy</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
            <span class="n">session</span><span class="o">.</span><span class="n">trust_env</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">client_kwargs</span><span class="p">[</span><span class="s2">&quot;http_session&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span>

        <span class="c1"># Create and connect to the server to communicate with Alias</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__sio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tk_alias</span><span class="o">.</span><span class="n">ShotGridAliasSocketIoClient</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="o">**</span><span class="n">client_kwargs</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sio</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to create socketio client&quot;</span><span class="p">)</span>

        <span class="c1"># Connect to the server to start communicating</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__sio</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>

        <span class="c1"># Return the connection status</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sio</span><span class="o">.</span><span class="n">connected</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__init_api</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hostname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the Alias Python api module to allow communication with Alias.</span>

<span class="sd">        The api can be initialized for either OpenAlias (GUI) or OpenModel (headless/batch)</span>
<span class="sd">        mode.</span>

<span class="sd">        For OpenAlias, the hostname, port and namespace arguments must be provided. These are</span>
<span class="sd">        required to connect to the running instance of Alias via a socketio server, which will</span>
<span class="sd">        provide the Alias API access.</span>

<span class="sd">        For OpenModel, none of the arguments are needed. Instead of connecting to a server to</span>
<span class="sd">        access the Alias API, the Alias Python API module can be directly imported (since it</span>
<span class="sd">        does not need to communicate with a running instance of Alias).</span>

<span class="sd">        :param hostname: For OpenAlias, the server host name to connect to, to access the api.</span>
<span class="sd">        :type hostname: str</span>
<span class="sd">        :param port: For OpenAlias, the server port to connect to, to access the api.</span>
<span class="sd">        :type port: int</span>
<span class="sd">        :param namespace: For OpenAlias, the server namespace to connect to, to access the api.</span>
<span class="sd">        :type namespace: str</span>
<span class="sd">        :param force: Force the api to be initialized, even if it has already been initialized.</span>
<span class="sd">        :type force: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__alias_py</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
            <span class="c1"># Already initialized.</span>
            <span class="k">return</span>

        <span class="n">api_module</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">api_proxy_module</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__in_alias_process</span><span class="p">:</span>
            <span class="c1"># Flow Production Tracking is running in the same process as Alias. This is the old way that the</span>
            <span class="c1"># engine was set up for, and will not work with Alias versions that use Qt for its</span>
            <span class="c1"># GUI (&gt;=2024.0).</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">alias_api</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">api_import_error</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Failed to import Alias Python API in same process as Alias.</span><span class="se">\n</span><span class="si">{</span><span class="n">api_import_error</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="n">api_module</span> <span class="o">=</span> <span class="n">alias_api</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__has_ui</span><span class="p">:</span>
                <span class="c1"># When running Flow Production Tracking in the same process as Alias, the qt app needs to be</span>
                <span class="c1"># created by the engine</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__init_qt_app</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Flow Production Tracking is running in a separate process than Alias. This is the new way how</span>
            <span class="c1"># the engine operates: the Alias plugin will bootstrap the engine in a separate</span>
            <span class="c1"># process than Alias (to avoid Qt conflicts between QtQuick/QML and QWidgets).</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__is_open_model</span> <span class="ow">or</span> <span class="kc">None</span> <span class="ow">in</span> <span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">namespace</span><span class="p">):</span>
                <span class="c1"># Run in OpenModel model (headless/batch), directly import the Alias Python API</span>
                <span class="c1"># module for OpenModel, which should already be imported via importing the</span>
                <span class="c1"># tk-framework-alias module (in python/tk_alias/framework_alias.py).</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">import</span><span class="w"> </span><span class="nn">alias_api_om</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">api_import_error</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Failed to import Alias Python API for OpenModel.</span><span class="se">\n</span><span class="si">{</span><span class="n">api_import_error</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                <span class="n">api_module</span> <span class="o">=</span> <span class="n">alias_api_om</span>
                <span class="c1"># Initialize the universe to make the api ready for requests.</span>
                <span class="n">api_module</span><span class="o">.</span><span class="n">initialize_universe</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Run in OpenAlias mode, an instance of Alias should be running with a server</span>
                <span class="c1"># listening for client connections to communicate with. Using the socket</span>
                <span class="c1"># communication, the api will be imported.</span>
                <span class="n">connected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__setup_sio</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">connected</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to connect to Alias api server&quot;</span><span class="p">)</span>

                <span class="c1"># Get the server info and api module through the socket connection</span>
                <span class="n">api_proxy_module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sio</span><span class="o">.</span><span class="n">get_alias_api_module_proxy</span><span class="p">()</span>
                <span class="n">api_module</span> <span class="o">=</span> <span class="n">api_proxy_module</span><span class="o">.</span><span class="n">get_or_create_module</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__sio</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">api_module</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to get Alias Python API from proxy module.&quot;</span><span class="p">)</span>

        <span class="c1"># Create the AliasPy object to wrap the api module. All Alias api requests can be made</span>
        <span class="c1"># directly with the AliasPy object, it will route the request to the actual api module</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__alias_py</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tk_alias</span><span class="o">.</span><span class="n">AliasPy</span><span class="p">(</span><span class="n">api_module</span><span class="p">,</span> <span class="n">api_proxy_module</span><span class="p">)</span>

        <span class="c1"># Allow the AliasPy object to be imported. This is for backward compatibility with</span>
        <span class="c1"># previous engine versions aceessing the alias_api.pyd module directly through import</span>
        <span class="n">sys_module_name</span> <span class="o">=</span> <span class="s2">&quot;alias_api&quot;</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">sys_module_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__alias_py</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Sanity check that the module can be imported.</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">alias_api</span>

            <span class="k">assert</span> <span class="n">alias_api</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">__alias_py</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">import_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to set up the Alias Python API module</span><span class="se">\n</span><span class="si">{</span><span class="n">import_error</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__init_alias_event_watcher</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the Alias event watcher.</span>

<span class="sd">        Register any initial Alias message event callbacks, and start watching for events immediately.</span>

<span class="sd">        NOTE: registering callback for event AlMessageType.DagNameModified causes a crash on startup.</span>
<span class="sd">        This looks like a bug where Alias is not ready to handle events yet but we can register them.</span>

<span class="sd">        :return: The Alias event watcher object.</span>
<span class="sd">        :rtype: AliasEventWatcher</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">event_watcher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tk_alias</span><span class="o">.</span><span class="n">alias_event_watcher</span><span class="o">.</span><span class="n">AliasEventWatcher</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Register event callbacks</span>
        <span class="n">event_watcher</span><span class="o">.</span><span class="n">register_alias_callback</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_stage_active</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alias_py</span><span class="o">.</span><span class="n">AlMessageType</span><span class="o">.</span><span class="n">StageActive</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Now start watching the events. This should be called after registering events to</span>
        <span class="c1"># ensure the event watcher starts listening.</span>
        <span class="n">event_watcher</span><span class="o">.</span><span class="n">start_watching</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">event_watcher</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__check_version_support</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that the Alias version is supported.</span>

<span class="sd">        The Alias version must be set before calling this method.</span>

<span class="sd">        The Qt application must be created before calling this method.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">sgtk.platform.qt</span><span class="w"> </span><span class="kn">import</span> <span class="n">QtGui</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_version</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t get Alias version. Skip version comparison&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alias_version</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_setting</span><span class="p">(</span>
            <span class="s2">&quot;compatibility_dialog_min_version&quot;</span><span class="p">,</span> <span class="mi">2020</span>
        <span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;The Flow Production Tracking Toolkit has not yet been fully tested &quot;</span>
                <span class="s2">&quot;with Alias </span><span class="si">%s</span><span class="s2">. You can continue to use the Toolkit but you may &quot;</span>
                <span class="s2">&quot;experience bugs or instability.  Please report any issues you see &quot;</span>
                <span class="s2">&quot;to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alias_version</span><span class="p">,</span> <span class="n">sgtk</span><span class="o">.</span><span class="n">support_url</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_ui</span><span class="p">:</span>
                <span class="n">QtGui</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_get_dialog_parent</span><span class="p">(),</span>
                    <span class="s2">&quot;Warning - Flow Production Tracking Toolkit!&quot;</span><span class="p">,</span>
                    <span class="n">msg</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">elif</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alias_version</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">2021</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_setting</span><span class="p">(</span>
            <span class="s2">&quot;compatibility_dialog_old_version&quot;</span>
        <span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;The Flow Production Tracking Toolkit is not fully capable with &quot;</span>
                <span class="s2">&quot;Alias </span><span class="si">%s</span><span class="s2">. You should consider upgrading to a more recent version &quot;</span>
                <span class="s2">&quot;of Alias. Please report any issues you see to </span><span class="si">%s</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alias_version</span><span class="p">,</span> <span class="n">sgtk</span><span class="o">.</span><span class="n">support_url</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_ui</span><span class="p">:</span>
                <span class="n">QtGui</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_get_dialog_parent</span><span class="p">(),</span>
                    <span class="s2">&quot;Warning - Flow Production Tracking Toolkit!&quot;</span><span class="p">,</span>
                    <span class="n">msg</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Version successfully checked and is supported</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__get_or_create_proxy_window</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a widget to parent all Flow Production Tracking windows to.</span>

<span class="sd">        This widget itself will be parented to the Alias main window.</span>

<span class="sd">        This method must be called after Qt and the Alias Python API has been initialized.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_ui</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># import alias_api</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">sgtk.platform.qt</span><span class="w"> </span><span class="kn">import</span> <span class="n">QtGui</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__proxy_window</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alias_py</span><span class="p">,</span> <span class="s2">&quot;set_parent_window&quot;</span><span class="p">):</span>
                <span class="c1"># The Alias API version &gt;= 4.0.0 provides functions to manage the Alias main</span>
                <span class="c1"># window (e.g. set as parent to Flow Production Tracking windows)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__proxy_window</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QWidget</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__proxy_window</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__PROXY_WINDOW_TITLE</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alias_py</span><span class="o">.</span><span class="n">set_parent_window</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__proxy_window</span><span class="o">.</span><span class="n">winId</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__proxy_window</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_tk_alias</span><span class="o">.</span><span class="n">DialogParent</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_ui</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__proxy_window</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tk_alias</span><span class="o">.</span><span class="n">DialogParent</span><span class="p">):</span>
            <span class="n">window</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__proxy_window</span><span class="o">.</span><span class="n">get_dialog_parent</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">window</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">window</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">activeWindow</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Adjust window to center of Alias main window (this will only take effect when using</span>
            <span class="c1"># Alias Python API version &gt;= 4.0.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alias_py</span><span class="o">.</span><span class="n">adjust_window</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__proxy_window</span><span class="o">.</span><span class="n">winId</span><span class="p">())</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__proxy_window</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__run_app_instance_commands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the series of app instance commands listed in the &#39;run_at_startup&#39; setting</span>
<span class="sd">        of the environment configuration yaml file.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Build a dictionary mapping app instance names to dictionaries of commands they registered with the engine.</span>
        <span class="n">app_instance_commands</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">command_name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">app_instance</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;app&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">app_instance</span><span class="p">:</span>
                <span class="c1"># Add entry &#39;command name: command function&#39; to the command dictionary of this app instance.</span>
                <span class="n">command_dict</span> <span class="o">=</span> <span class="n">app_instance_commands</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
                    <span class="n">app_instance</span><span class="o">.</span><span class="n">instance_name</span><span class="p">,</span> <span class="p">{}</span>
                <span class="p">)</span>
                <span class="n">command_dict</span><span class="p">[</span><span class="n">command_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;callback&quot;</span><span class="p">]</span>

        <span class="n">commands_to_run</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Run the series of app instance commands listed in the &#39;run_at_startup&#39; setting.</span>
        <span class="k">for</span> <span class="n">app_setting_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_setting</span><span class="p">(</span><span class="s2">&quot;run_at_startup&quot;</span><span class="p">,</span> <span class="p">[]):</span>

            <span class="n">app_instance_name</span> <span class="o">=</span> <span class="n">app_setting_dict</span><span class="p">[</span><span class="s2">&quot;app_instance&quot;</span><span class="p">]</span>
            <span class="c1"># Menu name of the command to run or &#39;&#39; to run all commands of the given app instance.</span>
            <span class="n">setting_command_name</span> <span class="o">=</span> <span class="n">app_setting_dict</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

            <span class="c1"># Retrieve the command dictionary of the given app instance.</span>
            <span class="n">command_dict</span> <span class="o">=</span> <span class="n">app_instance_commands</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">app_instance_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">command_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> configuration setting &#39;run_at_startup&#39; requests app &#39;</span><span class="si">%s</span><span class="s2">&#39; that is not installed.&quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">app_instance_name</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">setting_command_name</span><span class="p">:</span>
                    <span class="c1"># Run all commands of the given app instance.</span>
                    <span class="k">for</span> <span class="n">command_name</span><span class="p">,</span> <span class="n">command_function</span> <span class="ow">in</span> <span class="n">command_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> startup running app &#39;</span><span class="si">%s</span><span class="s2">&#39; command &#39;</span><span class="si">%s</span><span class="s2">&#39;.&quot;</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">app_instance_name</span><span class="p">,</span>
                            <span class="n">command_name</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">commands_to_run</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command_function</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Run the command whose name is listed in the &#39;run_at_startup&#39; setting.</span>
                    <span class="n">command_function</span> <span class="o">=</span> <span class="n">command_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">setting_command_name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">command_function</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> startup running app &#39;</span><span class="si">%s</span><span class="s2">&#39; command &#39;</span><span class="si">%s</span><span class="s2">&#39;.&quot;</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">app_instance_name</span><span class="p">,</span>
                            <span class="n">setting_command_name</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">commands_to_run</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command_function</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">known_commands</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">command_dict</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> configuration setting &#39;run_at_startup&#39; requests app &#39;</span><span class="si">%s</span><span class="s2">&#39; unknown command &#39;</span><span class="si">%s</span><span class="s2">&#39;. &quot;</span>
                            <span class="s2">&quot;Known commands: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">app_instance_name</span><span class="p">,</span>
                            <span class="n">setting_command_name</span><span class="p">,</span>
                            <span class="n">known_commands</span><span class="p">,</span>
                        <span class="p">)</span>

        <span class="c1"># no commands to run. just bail</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">commands_to_run</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># finally, run the commands</span>
        <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">commands_to_run</span><span class="p">:</span>
            <span class="n">command</span><span class="p">()</span>

    <span class="c1">#####################################################################################</span>
    <span class="c1"># Pipeline config utils</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__get_pipeline_configuration_local_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the path to the local configuration (the one which stands in the Sgtk cache folder) in order to be able</span>
<span class="sd">        to build a :class`sgtk.Sgtk` instance from this path</span>

<span class="sd">        :param project: The project entity dict or id that we want to retrieve the config for.</span>
<span class="sd">            The project entity dict is required to perform the fallback code to ensure the</span>
<span class="sd">            pipeline config is loaded.</span>
<span class="sd">        :type project: dict | int</span>

<span class="sd">        :return: The local path to the config if we could determine which config to use, None otherwise.</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># For backward compatibility, allow passing the project id (instead of entity dict),</span>
        <span class="c1"># though if only the id is given, then the fallback code to load the pipeline config</span>
        <span class="c1"># will not be executed</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">project_id</span> <span class="o">=</span> <span class="n">project</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">project_id</span> <span class="o">=</span> <span class="n">project</span>
            <span class="n">project</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">plugin_id</span> <span class="o">=</span> <span class="s2">&quot;basic.desktop&quot;</span>

        <span class="c1"># first, start the toolkit manager to get all the pipeline configurations related to the distant project</span>
        <span class="c1"># here, we are going to use the default plugin id &quot;basic.*&quot; to find the pipeline configurations</span>
        <span class="n">mgr</span> <span class="o">=</span> <span class="n">sgtk</span><span class="o">.</span><span class="n">bootstrap</span><span class="o">.</span><span class="n">ToolkitManager</span><span class="p">()</span>
        <span class="n">mgr</span><span class="o">.</span><span class="n">plugin_id</span> <span class="o">=</span> <span class="n">sgtk</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">DEFAULT_PLUGIN_ID</span>
        <span class="n">pipeline_configurations</span> <span class="o">=</span> <span class="n">mgr</span><span class="o">.</span><span class="n">get_pipeline_configurations</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Project&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">project_id</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">pipeline_configurations</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Couldn&#39;t retrieve any pipeline configuration linked to project </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">project_id</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pipeline_configurations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">pipeline_config</span> <span class="o">=</span> <span class="n">pipeline_configurations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># try to determine which configuration we want to use:</span>
            <span class="c1"># 1- if one and only one pipeline configuration is restricted to this project, use it</span>
            <span class="c1"># 2- if one pipeline configuration is named Primary and linked to this project, use it</span>
            <span class="c1"># 3- reject all the other cases</span>

            <span class="n">pipeline_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_project_pipeline_configuration</span><span class="p">(</span>
                <span class="n">pipeline_configurations</span><span class="p">,</span> <span class="n">project_id</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">pipeline_config</span><span class="p">:</span>
                <span class="n">pipeline_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_primary_pipeline_configuration</span><span class="p">(</span>
                    <span class="n">pipeline_configurations</span><span class="p">,</span> <span class="n">project_id</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">pipeline_config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Couldn&#39;t get the pipeline configuration linked to project </span><span class="si">{}</span><span class="s2">: too many configurations&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">project_id</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">config_local_path</span> <span class="o">=</span> <span class="n">LocalFileStorageManager</span><span class="o">.</span><span class="n">get_configuration_root</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sgtk</span><span class="o">.</span><span class="n">shotgun_url</span><span class="p">,</span>
            <span class="n">project_id</span><span class="p">,</span>
            <span class="n">plugin_id</span><span class="p">,</span>
            <span class="n">pipeline_config</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
            <span class="n">LocalFileStorageManager</span><span class="o">.</span><span class="n">CACHE</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">config_local_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config_local_path</span><span class="p">,</span> <span class="s2">&quot;cfg&quot;</span><span class="p">)</span>

        <span class="c1"># If the config has not been loaded on on disk yet, force it to load before returning</span>
        <span class="c1"># the path.</span>
        <span class="k">if</span> <span class="n">project</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">config_local_path</span><span class="p">):</span>
            <span class="n">mgr</span> <span class="o">=</span> <span class="n">sgtk</span><span class="o">.</span><span class="n">bootstrap</span><span class="o">.</span><span class="n">ToolkitManager</span><span class="p">()</span>
            <span class="n">mgr</span><span class="o">.</span><span class="n">plugin_id</span> <span class="o">=</span> <span class="n">plugin_id</span>
            <span class="n">mgr</span><span class="o">.</span><span class="n">pipeline_configuration</span> <span class="o">=</span> <span class="n">pipeline_config</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
            <span class="n">mgr</span><span class="o">.</span><span class="n">prepare_engine</span><span class="p">(</span><span class="s2">&quot;tk-desktop&quot;</span><span class="p">,</span> <span class="n">project</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">config_local_path</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__get_project_pipeline_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline_configurations</span><span class="p">,</span> <span class="n">project_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the pipeline configuration list in order to find if one of them is only used by this project.</span>

<span class="sd">        :param pipeline_configurations: List of pipeline configurations to parse</span>
<span class="sd">        :param project_id:              Id of the project we want to get the pipeline configuration for</span>
<span class="sd">        :returns: The pipeline configuration if only one config has been defined for this project, None otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">pipeline_configuration</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">pc</span> <span class="ow">in</span> <span class="n">pipeline_configurations</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pc</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">pc</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">project_id</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pipeline_configuration</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="n">pipeline_configuration</span> <span class="o">=</span> <span class="n">pc</span>

        <span class="k">return</span> <span class="n">pipeline_configuration</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__get_primary_pipeline_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline_configurations</span><span class="p">,</span> <span class="n">project_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the pipeline configuration list in order to find if one of them has been defined as &quot;Primary&quot; for this</span>
<span class="sd">        project.</span>

<span class="sd">        :param pipeline_configurations: List of pipeline configurations to parse</span>
<span class="sd">        :param project_id:              Id of the project we want to get the pipeline configuration for</span>
<span class="sd">        :returns: The pipeline configuration if a &quot;Primary&quot; config has been found for this project, None otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">pc</span> <span class="ow">in</span> <span class="n">pipeline_configurations</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">pc</span><span class="p">[</span><span class="s2">&quot;project_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">project_id</span>
                    <span class="ow">and</span> <span class="n">pc</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                    <span class="o">==</span> <span class="n">sgtk</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">PRIMARY_PIPELINE_CONFIG_NAME</span>
                <span class="p">):</span>
                    <span class="k">return</span> <span class="n">pc</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No project_id key for </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pc</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>
</pre></div>
</div>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="changes.html" class="btn btn-neutral float-left" title="What’s New" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="hooks.html" class="btn btn-neutral float-right" title="Hooks" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Autodesk.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 

  <script type="text/javascript">
    window.wafCCPAForceShow = true;
    (function(a,b,c,d){
      a='https://tags.tiqcdn.com/utag/autodesk/micro-basic/prod/utag.js';
      b=document;c='script';d=b.createElement(c);d.src=a;d.type='text/java'+c;d.async=true;
      a=b.getElementsByTagName(c)[0];a.parentNode.insertBefore(d,a);
    })();
  </script>


</body>
</html>